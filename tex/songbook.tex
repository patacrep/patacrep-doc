%*******************************************************************************
%*******************************************************************************
\chapter{Songbook}
\setcounter{chapter}{1}
\label{chap:songbook}
\minitoc
\fancyhead[RE]{\textit{Chapitre \arabic{chapter}.~\nouppercase{\leftmark}}}
\fancyhead[LO]{\textit{\arabic{chapter}.\arabic{section}.~\nouppercase{\rightmark}}}
%*******************************************************************************
%*******************************************************************************


%*******************************************************************************
\section{Installation}
\label{sb:install}
%*******************************************************************************

De manière générale, évitez les chemins contenant des espaces
ou des caractères spéciaux. Dans ce manuel, le répertoire de travail
est supposé être~: \colarg{\$HOME/songbook} pouvant être noté
\colarg{/home/user/songbook} ou \colarg{$\sim$/songbook}.

%------------------------------------------------------------------------------
\subsection{\linux}
%------------------------------------------------------------------------------

Le songbook utilise \LaTeX{} pour la mise en page des chansons et
Python pour la génération des tables des matières (dépendances
obligatoires).  Il est également possible d'inclure en option des
partitions générées avec Lilypond. Enfin, le projet est distribué via
un dépôt git donc il est recommandé d'installer l'outil pour des
raisons de simplicité (dépendances recommandées). Enfin, vous aurez
besoin d'un logiciel pour lire les fichiers pdf produits. Si vous êtes
sous Debian/Ubuntu~:

\subsubsection{Dépendances}

Installation des dépendances obligatoires.
\begin{unixcom}
  sudo apt-get install texlive-base texlive-lang-french texlive-latex-extra
  sudo apt-get install python
\end{unixcom}

Installation des dépendances recommandées.
\begin{unixcom}
  sudo apt-get install texlive-fonts-recommended
  sudo apt-get install lilypond
  sudo apt-get install git-core
\end{unixcom}

\subsubsection{Téléchargement des sources}

Les sources peuvent être récupérées sous la forme d'une archive tar.gz

\begin{unixcom}
  wget http://www.patacrep.com/data/documents/songbook.tar.gz
  tar xzvf songbook.tar.gz
\end{unixcom}

ou sous la forme d'un dépôt \git

\begin{unixcom}
  git clone git://git.lohrun.net/songbook.git
\end{unixcom}


\paragraph{Exécution}

Un \emph{makefile} automatise tout le processus de compilation. 
Dans le répertoire du songbook~:

\begin{unixcom}
  make all
\end{unixcom}

Quelques options de base du makefile~:
\begin{itemize}
\item \command{\$ make clean}~: supprime tous les fichiers de logs et
  les fichiers générés à part les recueils finaux (pdf).
\item \command{\$ make cleanall}~: supprime tous les fichiers générés,
  y compris les pdf.
\item \command{\$ make lilypond}~: génère dans \colarg{./lilypond} les
  pdf de toutes les partitions lilypond (.ly) trouvées dans
  \colarg{./lilypond}. Il est nécessaire d'avoir installé
  \emph{lilypond} au préalable.
\item \command{\$ make book.pdf}~: la compilation de tous les carnets
  pouvant être longue, si seule une version précise vous intéresse,
  vous pouvez lancer la compilation d'un seul fichier pdf. À la place
  de \colarg{book.pdf}, vous pouvez mettre~:
\end{itemize}

\begin{center}
  \begin{tabular}{l l}
    \hline
    \command{make} & description \\
    \hline
    \colarg{songbook.pdf} &~: version complète avec toutes les chansons \\
    \colarg{volume-1.pdf} &~: volume 1 (171 premières chansons)\\
    \colarg{volume-2.pdf} &~: volume 2\\
    \colarg{naheulbeuk.pdf} &~: version spéciale Donjon de Naheulbeuk\\
    \colarg{english.pdf} &~: chansons en anglais uniquement\\
    \hline
  \end{tabular}
\end{center}

\begin{nota}
  La commande \command{make} sans option correspond à un \command{make
    \colarg{songbook.pdf}}.
\end{nota}


\subsection{\windows}


\subsubsection{Dépendances}

Installation des dépendances obligatoires.
\begin{itemize}
\item Miktex~: \url{http://miktex.org/2.8/setup}
\item Python~: \url{http://www.python.org/download/}
\item Java \url{http://www.java.com/fr/download/}
\end{itemize}

Installation des dépendances recommandées.
\begin{itemize} 
\item Lilypond~: \url{http://lilypond.org/install/}
\item MsysGit~: \url{http://code.google.com/p/msysgit/downloads/list}
\end{itemize}

\subsubsection{Modification de la variable \command{Path}}

Après avoir installé tous les logiciels obligatoires et/ou recommandés
vous devez rédémarrer votre machine.  Après le redémarrage, il faut
modifier la variable \command{Path} de votre système.
\begin{itemize}
\item Clic-droit sur Poste de travail (XP) ou sur Ordinateur (Vista,
  Seven) puis Propriétés.
\item Dans Paramètres Système Avancés, cliquez sur Variables
  d'environnement.
\end{itemize}

Dans la partie basse (Variables système) faîtes dérouler la liste
jusqu'à trouver \command{Path}. La variable est modifiable en
double-cliquant dessus. Le \command{Path} contient un ensemble de
chemins séparés par des \emph{points-virgules}.  Veuillez vous assurer
qu'elle contient bien les chemins vers~:
\begin{itemize}
\item Java~: \verb#C:\Program Files\Java\jre6\bin#
\item Phyton~: \verb#C:\textbackslash Python31#
\item Miktex~: \verb# C:\Program Files\MiKTeX 2.8\miktex\bin#
\item Lilypond~: \verb#C:\Program Files\LilyPond\usr\bin#
\end{itemize}                     

Si certains chemins viennent à manquer, ajoutez les vous-même. Si la
variable a été modifiée, vous devrez rédémarrer votre ordinateur.

\paragraph{Exécution}
Placez-vous dans votre répertoire \colarg{songbook/}.
\begin{itemize}
\item Copiez les deux fichiers \colarg{make.bat} et \colarg{make.jar}
\item Exécutez le \colarg{make.jar}
\end{itemize}

Une interface graphique vous permet de~:
\begin{itemize}
\item \Key{Clean}~: supprimer les fichiers temporaires
\item \Key{Clean All}~: supprimer les fichiers temporaires et les
  pdf.
\item \Key{Make Lilypond}~: générer les partitions Lilypond du
  dossier \colarg{lilypond/}.
\item cliquer sur une version particulière du songbook pour le
  compiler.
\end{itemize}

\begin{nota}
  Les fichiers \colarg{make.bat} et \colarg{make.jar} sont disponibles
  dans l'archive songbook-windows.zip~:
  \url{http://www.patacrep.com/data/documents/songbook-windows.zip}.
\end{nota}



%*******************************************************************************
\section{Description du contenu}
\label{sb:contents}
%*******************************************************************************

\paragraph{\command{./utils}}
Contient un ensemble de scripts utilitaires. Un script s'exécute par la commande~:

\begin{unixcom}
  ./utils/script.sh
\end{unixcom}

\begin{itemize}
\item \command{resize-cover.sh}~: permet de redimensionner
  automatiquement tous les fichiers .jpg du répertoire
  \colarg{songbook/songs} correspondant aux pochettes des albums. À
  exécuter après l'ajout d'une nouvelle pochette jpg.

\item \command{latex-preprocessing.py}~: applique un ensemble de
  règles automatiques pour les notations \LaTeX{} de certains
  caractères et pour les notations d'accords.  À exécuter après
  l'ajout d'une nouvelle chanson pour être sûr de respecter les
  standards du songbook.

\item \command{typo.sh}~: applique un ensemble de règles
  typographiques comme la suppression des espaces doubles ou la
  gestion des guillemets.

\item \command{new-songs-list.sh}~: permet de récupérer la liste des
  chansons ajoutées depuis la dernière version.

\item \command{make-html.sh}~: génère la liste de toutes les chansons
  au format html.
\end{itemize}

\paragraph{\command{./templates}}
Contient les fichiers de style du songbook et permet de modifier des
paramètres comme la police utilisée, les différentes couleurs
utilisées etc.

\begin{itemize}
\item \command{patacrep.tmpl}~: template par défaut correspondant à la
  mise en page classique.
\item \command{patacrep-en.tmpl}~: version traduite en anglais du
  template par défaut.
\item \command{minimal.tmpl}~: une version plus compacte sans page de
  garde ni table des matières.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FIGURE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
  \centering
  %% -- subfigures --
  \subfigure[]{
    \label{fig:templates-a}
    \includegraphics[width=0.8\textwidth]{templates-a}%
  }%
  \hspace{0.1cm}%
  \subfigure[]{%
    \label{fig:templates-b}%
    \includegraphics[width=0.8\textwidth]{templates-b}%
  }%
  %% -- subfigures --
  \caption[Templates]{% 
    Templates.
    \subref{fig:templates-a}~\command{patacrep.tmpl}; % 
    \subref{fig:templates-b}~\command{minimal.tmpl}~. %
  }%
  \label{fig:fenetre-pointel-2}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\paragraph{\command{./songs}}
Contient l'ensemble des chansons disponibles sous la forme de fichiers
\command{.sg}. Chaque chanson se trouve dans un sous-répertoire du nom
de l'artiste. Par exemple~:
\command{songs/Pornophonique/Sad\_robot.sg}.

\paragraph{\command{./lilypond}}
Contient les partitions \lilypond sous la forme de fichiers
\command{.ly}.

\paragraph{\command{./tex}}
Contient différents fichiers \LaTeX{} (licences etc.).

\paragraph{\command{./img}}
Contient les images utilisées dans les songbooks (exceptés les
pochettes des albums). Pour rajouter \command{my\_image.jpg} dans une
chanson, utilisez la macro \latexcom{image} dans un fichier
\command{.sg}. Cette macro se comporte comme la commande \LaTeX{}
\latexcom{includegraphics}.

\begin{unixcom}
  \image[width=4cm]{mon\_image}
\end{unixcom}

%*******************************************************************************
\section{Créer un recueil}
\label{sb:create-songbook}
%*******************************************************************************

\paragraph{Fichiers songbook}
Les fichiers songbook \command{.sb} contiennent un ensemble d'options
pour la personnalisation du recueil ainsi qu'une liste de
chansons. 

\begin{center}
\begin{verbatim}
{
"template" : "minimal.tmpl",
"bookoptions" : [
    "diagram",
    "lilypond",
    "pictures"
  ],
"songs" : [
    "Le_Donjon_de_Naheulbeuk/10_sous_dans_ma_poche.sg",
    "Le_Donjon_de_Naheulbeuk/Bugger_off.sg"
  ]
}
\end{verbatim}
\end{center}

Pour compiler votre recueil  \command{mybook.sb}~:
\begin{unixcom}
  make mybook.pdf
\end{unixcom}


%*******************************************************************************
\section{Écrire une chanson}
\label{sb:write-song}
%*******************************************************************************

%------------------------------------------------------------------------------
\subsection{Éléments principaux}
%------------------------------------------------------------------------------

Une chanson est un simple fichier texte \colarg{chanson.sg} placé dans
le répertoire \colarg{songs/Artiste}. Les espaces n'étant pas
tolérées, veillez à utiliser des underscores. L'en-tête d'un fichier
\command{.sg} se présente de la manière suivante~:

\begin{verbatim}
    \beginsong{Titre}
              [by=Artiste,cov=album-cover]
\end{verbatim}

Les paramètres \command{Titre}, \command{Artiste} et
\command{album-cover} sont à renseigner pour chaque nouvelle
chanson. \command{album-cover} désigne un fichier
\colarg{album-cover.jpg} devant se trouver dans le même répertoire que
le fichier .sg.  La chanson se compose d'une succession de couplets
(verse en anglais) et de refrains (chorus). Un couplet est alors
encadré par les balises \latexcom{beginverse} et
\latexcom{endverse}. De la même manière, un refrain se trouve entre
les balises \latexcom{beginchorus} et \latexcom{endchorus}.  Les
paroles sont écrites normalement entre le \latexcom{begin} et le
\latexcom{end}. Pour préciser sur quelle syllabe un accord doit être
joué, on utilise une commande spéciale. Par exemple, la commande
\latexcom{[Mi]} produira un \command{Mi} au dessus de la syllabe
suivante. Vous pouvez utiliser n'importe quel texte pour désigner un
accord.

\begin{center}
\begin{verbatim}
\beginverse
His \[Rém]steely skin is covered
  By \[Fa]centuries of dust
    \[Do]Once he was a great one
      \[Rém]Now he's dull and rust
        \endverse
\end{verbatim}
\end{center}

Chaque chanson se termine avec la commande \latexcom{endsong}.

%------------------------------------------------------------------------------
\subsection{Règles de style}
%------------------------------------------------------------------------------

\paragraph{Notation des accords}
La convention de nommage des accords du recueil n'est \emph{pas} la
convention anglo-saxone désignation des accords par (A, B, C, D, E, F,
G) mais la notation latine (La, Si, Do, Ré, Mi, Fa, Sol). Par défaut,
l'accord est majeur (Do fait référence à l'accord de Do majeur). Les
accords mineurs sont précisés par un \command{m} minuscule.  Le
symbole bémol ($\flat$) est représenté en utilisant le caractère
\command{\&}.  Le dièse ($\sharp$) est codé par le caractère
\command{\#}. Les autres notations sont simplement ajoutées comme des
caractères à l'accord principal. Par exemple, l'accord de \command{La
  bémol mineur} est noté \latexcom{[La\&m]}.

\paragraph{Répétition des accords}
De façon à avoir un document lisible et relativement compact, les
accords des couplets et des refrains ne sont renseignés qu'une seule
fois à leur première occurence. En effet, même si jouer les morceaux
du premier couplet en chantant les paroles du second peut demander un
peu de gymnastique, cela fera travailler votre mémoire tout en offrant
un texte bien moins surchargé et (beaucoup) moins de pages à imprimer.

\paragraph{Typographie}
Chaque ligne commence par une majuscule. La ponctuation en fin de
ligne est laissée au choix de celui qui transcrit la chanson.  Les
signes composés ``; : ! ?'' prennent une espace avant en français,
mais pas en anglais. Les majuscules s'accentuent. On écrit : ``À
bientôt.'' et non pas ``A bientôt.''.

\paragraph{Numérotation des couplets et Sauts de ligne}
La numérotation se fait automatiquement pour chaque
\latexcom{beginverse} rencontré. Cependant, il est parfois plus
lisible de scinder un couplet en deux parties, la deuxième partie ne
devant pas être numérotée. Pour cela on utilise la commande
\latexcom{beginverse*}. Par exemple, un couplet en huit strophes se
décompose souvent en $2 \times 4$ strophes comme dans l'exemple
suivant.

\begin{verbatim}
\beginverse
  His \[Rém]steely skin is covered
  By \[Fa]centuries of dust
  \[Do]Once he was a great one
  \[Rém]Now he's dull and rust
\endverse

\beginverse*
  An oily tear he's crying
  Can you feel the pain
  Of the sad, sad robot
  And it's driving him insane
\endverse
\end{verbatim}

\paragraph{Agencement en colonnes}
La commande \latexcom{songcolumns} détermine le nombre de colonnes sur
lequel sera présentée la chanson. Elle s'utilise juste avant la
commande \latexcom{beginsong}. Vous pouvez indiquer le nombre de
colonnes à utiliser pour écrire votre chanson (généralement 1, 2 ou
3). Par convention, utilisez deux colonnes par défaut.

\begin{verbatim}
\songcolumns{2}
\beginsong{Titre}
\end{verbatim}

\paragraph{Caractères spéciaux}
Quelques caractères doivent être codés différemment en utilisant des
commandes \LaTeX{} pour un meilleur résultat. Les deux exemples
principaux sont les 3 points (\dots) et le caractère \oe{}. Pour
représenter ces caractères, vous devez utiliser respectivement les
commandes \latexcom{dots} et \latexcom{oe\{\}} (ou utiliser le
caractère utf-8 \command{œ}). On utilise des accolades autour des
commandes de sorte que les commandes puissent être insérées où vous le
désirez sans interférer avec le reste du texte. Voir aussi la section
utilitaires \refsec{sec:utilitaires}.

\paragraph{Ch\oe{}urs et répétitions}
Lorsqu'une phrase ou un couplet est répété plusieurs fois d'affilée,
utiliser la commande \latexcom{rep} plutôt que d'écrire \emph{bis} ou
d'indiquer directement (x4). Pour faire répéter quatre fois une
strophe, utilisez la commande suivante à la fin de la ligne. La
commande \latexcom{echo} fait référence à des chœurs (ou similaire).

\begin{verbatim}
Hallelujah \echo{Hallelujah} \rep{4}
\end{verbatim}


\paragraph{Diagrammes des accords}
Étant donné qu'un accord de guitare peut se jouer de plusieurs façons
différentes et qu'il est parfois judicieux de privilégier telle ou
telle position, le songbook permet de représenter schématiquement ces
accords en début de chanson. On utilise la commande \latexcom{gtab}
juste avant le premier couplet ou refrain. Voici quelques exemples
classiques~:

\begin{verbatim}
\gtab{Ré}{XX0232}
\gtab{Mi}{022100}
\gtab{Do}{3:002220}
\end{verbatim}

\begin{itemize}
\item les 6 chiffres correspondent aux 6 cordes de la guitare
  (\command{Mi}, \command{La}, \command{Ré}, \command{Sol},
  \command{Si}, \command{Mi})~;
\item la valeur du chiffre indique la fret (case) sur laquelle on
  appuie~;
\item 0 désigne une corde jouée à vide~;
\item X indique que la corde ne doit pas être jouée~;
\item une valeur avant un ``:'' désigne un barré~: \emph{3:} indique un
  barré de trois frets.
\end{itemize}

%------------------------------------------------------------------------------
\subsection{Intégration de partitions \lilypond}
%------------------------------------------------------------------------------

Si vous voulez rajouter une ligne mélodique dans une chanson, vous
pouvez utiliser lilypond pour générer la partition. Créez pour cela un
nouveau fichier \colarg{partition.ly} dans le répertoire
\colarg{songbook/lilypond}.  Il faut inclure le fichier d'en-tête
\colarg{header} et définir l'option paper-height de façon à ce que la
partition produite tienne sur une page avec le moins de blanc
possible. Une première estimation est de compter 1.6cm pour une
ligne. Puis, écrivez votre partition entre accolades
(voir~\reffig{fig:lilypond}).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FIGURE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
  \begin{minipage}[b]{\linewidth}
    \centering
    \includegraphics[width=0.8\textwidth]{lilypond}
    \vspace{0.5cm}
  \end{minipage}

  \begin{minipage}[b]{\linewidth}
\begin{verbatim}
\include "header" 
\paper{paper-height = 3.3\cm} 
{
  \key c \major 
  \time 2/4 
  \relative c''
    {
      e4 c g'2 a4 a8. a16 g8 e4 c8 
      a'4 a8. a16 g8 f e c d2~ d4 
      e8 f g4 g8. g16 f8 e d c a c4 a8 g4 
      c8 d e8 g4 g,8 e' e d d c2
    } 
}
\end{verbatim}
  \end{minipage}
  \caption{Intégration de partitions avec \lilypond.}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Enfin, pour insérer votre partition \command{sheet.ly} dans une
chanson, utilisez la commande \latexcom{lilypond} le fichier
\command{.sg} adéquat~:

\begin{verbatim}
\lilypond{sheet}
\end{verbatim}


%------------------------------------------------------------------------------
\subsection{Exemple}
%------------------------------------------------------------------------------

Voici l'exemple complet de la chanson \textit{Sad robot} par
\textit{Pornophonique} pouvant être utilisé comme point de départ pour
écrire une nouvelle chanson.

%*\newpage
%\begin{tabular*}{\textwidth}{@{\extracolsep{\fill}} *{2} m{5cm}}
\begin{multicols}{2}
\begin{verbatim}
\selectlanguage{english}
\songcolumns{2}
\beginsong{Sad robot}
  [by=Pornophonique,
      cov=8-bit-lagerfeuer]

  \cover
  \gtab{Rém}{XX0231}
  \gtab{Fa}{1:022100}
  \gtab{Do}{X32010}

  \lilypond{Sad_robot}

  \beginverse
    His \[Rém]steely skin is covered
    By \[Fa]centuries of dust
    \[Do]Once he was a great one
    \[Rém]Now he's dull and rust
  \endverse

  \beginverse*
    An oily tear he's crying
    Can you feel the pain
    Of the sad, sad robot
    And it's driving him insane
  \endverse

  \beginverse*
    He can't turn back time nor history
    So his life became a misery
    He has to face the destiny
    Nobody cares anymore
  \endverse

  \beginchorus
    Sad, sad robot
    Sad, sad robot
    Sad, sad robot
    All alone
  \endchorus
\end{verbatim}

\columnbreak

\begin{verbatim}
  \beginchorus
    He's a sad, sad robot \rep{3}
    He's so alone
  \endchorus

  \beginverse
    Me steely skin is covered
    By centuries of dust
    Once me was a great one
    But now I'm dull and rust
  \endverse

  \beginverse*
    An oily tear I'm crying
    Can you feel me pain
    I'm the sad, sad robot
    Driving me insane
  \endverse

  \beginverse*
    I can't turn back time nor history
    So me life became a misery
    I have to face me destiny
    That I'm all on me own
  \endverse

  \beginchorus
    Red, red robot
    I'm a red, red robot \rep{2}
    And so I shall return
  \endchorus

  \beginchorus
    I'm a red, red robot \rep{3}
    So I shall return
  \endchorus
\endsong
\end{verbatim}
\end{multicols}
%\\
%\multirow{2}{*}{\colarg{songs/Pornophonique/Sad\_robot.sg}}
%\\
%\end{tabular*}


